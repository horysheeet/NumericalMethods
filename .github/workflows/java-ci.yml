name: Java Backend CI/CD

on:
  push:
    branches: [ main ]
    paths:
      - 'java-backend/**'
      - '.github/workflows/java-ci.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'java-backend/**'

jobs:
  build-and-test:
    name: Build and Test Java Backend
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        java-version: ['17', '21']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK ${{ matrix.java-version }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ matrix.java-version }}
        distribution: 'temurin'
        cache: 'maven'
        
    - name: Build with Maven
      run: |
        cd java-backend
        mvn clean install -B -V
        
    - name: Run tests
      run: |
        cd java-backend
        mvn test -B
        
    - name: Generate test coverage
      run: |
        cd java-backend
        mvn jacoco:report
        
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      if: matrix.java-version == '21'
      with:
        file: ./java-backend/target/site/jacoco/jacoco.xml
        flags: java-backend
        name: java-backend-coverage
        fail_ci_if_error: false
        
    - name: Build Docker image (test only)
      if: matrix.java-version == '21'
      run: |
        docker build -t numerical-methods-java:test -f java-backend/Dockerfile .
        
    - name: Test Spring Boot startup
      run: |
        cd java-backend
        timeout 30 mvn spring-boot:run &
        sleep 15
        curl http://localhost:8080/api/jacobi/health || exit 1
        
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'maven'
        
    - name: Run Checkstyle
      run: |
        cd java-backend
        mvn checkstyle:check || true
        
    - name: Run SpotBugs
      run: |
        cd java-backend
        mvn spotbugs:check || true
        
    - name: Dependency vulnerability check
      run: |
        cd java-backend
        mvn org.owasp:dependency-check-maven:check || true
